<!DOCTYPE html>

<meta charset="utf-8" />

<title>WebSocket Test</title>
<style>
 table, td {
     border: 1px solid black;
 }
 
</style>
<script src="debug/liveGraph.js"></script> 
<script language="javascript" type="text/javascript">

 /* TODO:
    - make it so you can send arbitrary data and be able to graph it
    - have a 'terminal' type thing for printing debug
    - have a 'freeze' button that duplicates data
    
    Code ideas:
    d - Data/Display : prefix for data        [IMPLEMENTED]
    v - variables/values : used to communicate which variables to adjust       [PARTIAL]
    t/c/l - terminal/text/console/log : text display, similar to serial out
    s - setting/setup : setup/initialize stuff such as maxlength, canvas #/size etc. (use JSON's?)

    .          if the browser sends an empty packet ('v') then the esp32 
    .          should respond with registered variables and their current
    .          value ('v var1 12, var2 7.231, var3 hello world,')
    .

    All packets must be at least 2 characters (typically the type followed by a space).

  */
 
 var wsUri = "ws://"+window.location.host+"/websocket/ws.cgi";
 
 function init() {
     output = document.getElementById("output");
     testWebSocket();
     configDataSetup();
 }


 function testWebSocket() {
     websocket = new WebSocket(wsUri);
     websocket.onopen = function(evt) { onOpen(evt) };
     websocket.onclose = function(evt) { onClose(evt) };
     websocket.onmessage = function(evt) { onMessage(evt) };
     websocket.onerror = function(evt) { onError(evt) };
 }

 function onOpen(evt) {
     writeToScreen("CONNECTED");
     doSend("WebSocket rocks");
 }

 function onClose(evt) {
     writeToScreen("DISCONNECTED");
 }
 
 function onError(evt)  {
     writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
 }

 function doSend(message)
 {
     writeToScreen("SENT: " + message); 
     websocket.send(message);
 }
 
 
 function onMessage(evt)
 {
     /* split data into pairs of label/value */
     var incomingData = evt.data.substr(2);
     
     if(evt.data[0] == "d") {/* Data packet */
	 processDataPacket(incomingData);
	 
     } else if (evt.data[0] == "v") {/* variable packet */
	 processVariablePacket(incomingData);
	 processDataPacket(incomingData);/* TODO: This is just a hack to get stuff working since processVariablePacket isn't implemented */
	 
     } else {
	 writeToScreen('<span style="color: blue;">RECEIVED: ' + evt.data+'</span>');
     }
	 graph();
 }

 function processDataPacket (data) {
     data = data.split(",");
     data = data.map(function(e) { return e.trim().split(" "); } );

     /* go through each label and update as needed */
     for ( var d of data ) {

	 /* If it isn't in variables, add it with defaults*/
	 if( ! (d[0] in variables) ) {
	     createNewVariable(d[0]);
	 }
	 
	 var cur = variables[d[0]];/* shorthand for current variable */
	 cur.hist.push(d[1]);
	 /* at max length, shift out oldest data */
	 if(cur.hist.length > cur.maxLength) {
	     cur.hist.shift();
	 }
     }
 }



 function writeToScreen(message)
 {
     var pre = document.createElement("p");
     pre.style.wordWrap = "break-word";
     pre.innerHTML = message;
     output.appendChild(pre);
 }

 function sendPacketButton() {
     websocket.send(document.getElementById("packetData").value);
 }


 window.addEventListener("load", init, false);

</script>


<h2>Debug!</h2>
<canvas id="variableGraph" width="600" height="300" style="border:1px solid #000000;"></canvas>
<br>

<br>
<h2>Data Config:</h2>
<table id="dataConfig"></table>

<br>
<h2>WebSocket Test</h2>

<input type="text" name="Packet to Send" id="packetData" value="help">
<button onclick="sendPacketButton()">Send Packet</button>

<div id="output"></div>
