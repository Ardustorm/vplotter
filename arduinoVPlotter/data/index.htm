
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Test</title>
    <input type="text" id="test"  value="" />
    <button onclick="ws.send(document.getElementById('test').value)" id="testButton" >Send</button>
    <br/>

    <script type="text/javascript">
      var ws = null;

      function sendBlob(str){
          var buf = new Uint8Array(str.length);
          for (var i = 0; i < str.length; ++i) buf[i] = str.charCodeAt(i);
          ws.send(buf);
      }


      var variables = new Array();

      var myVar;
      function processData(d) {
          var view = new DataView(d);
          var i = 1;
          while(i+1 < d.byteLength) {
              console.log("Num: " + view.getUint8(i));
              i++;
              // TODO: need way to add way to identify if Int or Float
              console.log("I: " + view.getInt32(i, true) + "\tF: " + view.getFloat32(i, true));
              i+=4;
          }
      }
      function processSetup(d) {
          var arr = new Uint8Array(d)
          var i = 1;
          while(i < d.byteLength) {
              var num = arr[i++];
              // TODO: Add ability to process type
              var str = String.fromCharCode.apply(String, new Uint8Array(d, i, (arr.indexOf(0,i))-i));
              console.log("Num: " + num);
              console.log(str);
              i = arr.indexOf(0,i) + 1;
          }
      }
      function testFunc(d) {
          myVar = d;
          var view = new DataView(d);
          var opcode = String.fromCharCode(view.getUint8(0));
          if(opcode == 'S'){
              processSetup(d);

          } else if(opcode == 'D') {
              processData(d);

          } else {
              console.log("unknown");
          }
      }
      function startSocket(){
          // ws = new WebSocket('ws://'+document.location.host+'/ws',['arduino']);
          ws = new WebSocket('ws://192.168.0.180/ws',['arduino']);
          ws.binaryType = "arraybuffer";
          ws.onerror = function(e){
              console.log("ws error", e);
          };
          ws.onmessage = function(e){
              var msg = "";
              if(e.data instanceof ArrayBuffer){
                  // msg = "BIN:" +
                  //      Array.prototype.map.call(new Uint8Array(e.data), x => ('00' + x.toString(16)).slice(-2)).join('');
                  testFunc(e.data);
              } else {
                  msg = "TXT:"+e.data;
              }
          };

      }
      function onBodyLoad(){
          startSocket();
      }
    </script>
  </head>
  <body id="body" onload="onBodyLoad()">
    <pre id="dbg"></pre>
    <div id="input_div">
      $<input type="text" value="" id="input_el">
    </div>
  </body>
</html>
